<!DOCTYPE html>
<html>
<head>
    <title>Debug Auth - Madres Digitales</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>🔍 Debug Auth - Madres Digitales</h1>
    
    <div>
        <button class="button" onclick="checkLocalStorage()">📱 Check localStorage</button>
        <button class="button" onclick="testBackendLogin()">🔐 Test Backend Login</button>
        <button class="button" onclick="simulateFlutterLogin()">🎭 Simulate Flutter Login</button>
        <button class="button" onclick="clearStorage()">🗑️ Clear Storage</button>
    </div>
    
    <div id="output"></div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            output.appendChild(div);
            console.log(message);
        }

        function checkLocalStorage() {
            log('🔍 Checking localStorage...', 'info');
            
            const keys = ['flutter.auth_token', 'flutter.refresh_token', 'flutter.user_data'];
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    log(`✅ ${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`, 'success');
                    
                    if (key === 'flutter.user_data') {
                        try {
                            const userData = JSON.parse(value);
                            log(`👤 User: ${userData.nombre} - Role: ${userData.rol}`, 'info');
                        } catch (e) {
                            log(`❌ Error parsing user data: ${e.message}`, 'error');
                        }
                    }
                } else {
                    log(`❌ ${key}: Not found`, 'error');
                }
            });
        }

        async function testBackendLogin() {
            log('🔐 Testing backend login...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'wzuccardi@gmail.com',
                        password: '73102604722'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    log(`✅ Backend login successful!`, 'success');
                    log(`👤 User: ${data.user.nombre}`, 'success');
                    log(`🎭 Role: ${data.user.rol}`, 'success');
                    log(`🔑 Token: ${data.token.substring(0, 50)}...`, 'success');
                    
                    // Show full response
                    log(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');
                } else {
                    log(`❌ Backend login failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`❌ Backend login error: ${error.message}`, 'error');
            }
        }

        async function simulateFlutterLogin() {
            log('🎭 Simulating Flutter login...', 'info');
            
            try {
                // First, test backend login
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'wzuccardi@gmail.com',
                        password: '73102604722'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Store in localStorage like Flutter would
                    localStorage.setItem('flutter.auth_token', data.token);
                    if (data.refreshToken) {
                        localStorage.setItem('flutter.refresh_token', data.refreshToken);
                    }
                    localStorage.setItem('flutter.user_data', JSON.stringify(data.user));
                    
                    log(`✅ Login simulated successfully!`, 'success');
                    log(`🔑 Token stored in localStorage`, 'success');
                    log(`👤 User: ${data.user.nombre}`, 'success');
                    log(`🎭 Role: ${data.user.rol}`, 'success');
                    
                    log(`<br>🔄 Now refresh the Flutter app to see the Super Admin button!`, 'info');
                } else {
                    log(`❌ Login simulation failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`❌ Login simulation error: ${error.message}`, 'error');
            }
        }

        function clearStorage() {
            log('🗑️ Clearing storage...', 'info');
            
            const keys = ['flutter.auth_token', 'flutter.refresh_token', 'flutter.user_data'];
            keys.forEach(key => {
                localStorage.removeItem(key);
                log(`🗑️ Removed: ${key}`, 'info');
            });
            
            log(`🗑️ Storage cleared. Refresh the Flutter app to see the login screen.`, 'info');
        }

        // Auto-check localStorage on page load
        window.onload = function() {
            log('🚀 Debug Auth loaded', 'info');
            checkLocalStorage();
        };
    </script>
</body>
</html>
